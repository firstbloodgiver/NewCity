@model IEnumerable<NewCity.Models.StoryCard>
@using NewCity.Enum;
@{
    ViewData["Title"] = "Creator";
    EnumConditionType enumConditionType = new EnumConditionType();
}
<script src="~/js/enum.js"></script>
<!--故事卡包装为树。新建下一故事卡要在故事卡里面建-->
<div class="container-fluid">
    <div class="row">
        <div class="col-md-4">tree</div>
        <div class="col-md-8">
            <form target="fack" id="StoryCard" asp-action="Save" method="post" >
                <div class="row">
                    <div id="StoryId">
                        <input name="storyCard.ID" hidden value="@(Model.Count() > 0 ? Model.First().ID : Guid.Empty)" />
                        @(Model.Count() > 0 ? Model.First().ID : Guid.Empty)
                    </div>
                    <div id="StoryName">
                        @(Model.Count() > 0 ? Model.First().StoryName : "")
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4" id="Img">
                        <!--img-->
                        @(Model.Count() > 0 ? Model.First().IMG : "")
                    </div>
                    <div class="col-md-8" id="Content">
                        <!--text-->
                        <textarea name="storyCard.Text" class="form-control" rows="10">@(Model.Count() > 0 ? Model.First().Text : "")</textarea>
                    </div>
                </div>
                <div class="row" id="Option">
                    @if (Model.Count() != 0)
                    {
                        <input hidden id="optionCount" type="text" value="@Model.First().StoryOptions.Count()" />
                        int i = 0; //计算当前是第几个选项
                        @foreach (var item in Model.First().StoryOptions)
                        {
                            <div class="row" id="option-@item.ID">
                                <input name="storyCard.StoryOptions[@i].ID" hidden type="text" value="@item.ID" />

                                <button type="button" onclick="Condition('@i')">条件</button>
                                <input id="storyCard.StoryOptions[@i].Condition" name="storyCard.StoryOptions[@i].Condition" hidden type="text" value="@item.Condition" />

                                <input name="storyCard.StoryOptions[@i].Text" type="text" value="@item.Text">

                                <button type="button" onclick="Effect('@i')">效果</button>
                                <input name="storyCard.StoryOptions[@i].Effect" hidden type="text" value="@item.Effect" />

                                <button type="button" onclick="Cancel('option-@item.ID')">取消</button>
                                <button type="button" onclick="NextCard('@item.ID')">→</button>
                            </div>
                            i++;
                        }
                    }


                </div>
                <div class="form-group">
                    <button type="button" onclick="AddOption()">增加选项</button>
                </div>
                <div class="form-group">
                    <button type="submit" id="submit" onclick="Save()" class="btn">保存</button>
                </div>
            </form>
            <iframe name="fack" id="fack" style="display:none"></iframe>
        </div>
    </div>
</div>



<!--条件模态框-->
<div id="ConditionModel" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">模态框（Modal）标题</h4>
            </div>
            <div class="modal-body">
                <form id="ConditionForm"></form>
                <button onclick="AddCondition()">+</button>
                <button onclick="SaveCondition()">确定</button>
            </div>
        </div>
    </div>

  
</div>

<!--效果模态框-->
<div id="EffectModel" class="modal fade">
    <form id="EffectForm"></form>
    <button onclick="AddEffect()">+</button>
    <button onclick="SaveEffect()">确定</button>
</div>

<script>

   

    function GetStoryCard() {
        //点击树加载该故事卡到主页面
        
    }

    function Save() {
        setTimeout(function () {
            var a = window.frames["fack"].document.body.innerText;
            alert(a); }, 1000);   
    }

    //取消选项
    function Cancel(optionid) {
        $("#" + optionid).remove();
    }

    //下一张卡
    function NextCard(optionid) {

    }

    //增加选项
    function AddOption() {
        let optioncount = $("#optionCount").val();  //选项计数
        
       
        let id = guid();

        let optionID = "<input hidden type='text' name='storyCard.StoryOptions[" + optioncount + "].ID' value='" + id+"' />";
        let condition = "<button type='button' onclick='Condition(" + optioncount + ")'>条件</button> <input hidden name='storyCard.StoryOptions[" + optioncount + "].Condition' type='text' value='' />";
        let text = "<input type='text' name='storyCard.StoryOptions[" + optioncount + "].Text' value=''>";
        let effect = " <button type='button' onclick='Effect(" + optioncount + ")'>效果</button> <input name='storyCard.StoryOptions[" + optioncount + "].Effect' hidden type='text' value='' />";
        let button = " <button type='button' onclick=Cancel('option-"+id+"')>取消</button> <button type='button' onclick='NextCard('')'>→</button>";

        let toappend = "<div class='row' id=option-" + id +">" + optionID + condition + text + effect + button + "</div>"
        $("#Option").append(toappend)
        $("#optionCount").val(optioncount);
        optioncount++;
    }

    //设置条件
    var conditioncount = 0; //当前页面有多少个条件
    function Condition(number) {
        //清空条件模态框
        var ConditionForm = document.getElementById("ConditionForm");
        ConditionForm.innerHTML = "";
        conditioncount = 0;
        let Cd = $("#storyCard.StoryOptions[" + number + "].Condition").val();
        if (Cd) {
            let condition = JSON.parse(Cd);
            let q = "<input hidden type='text' id='ConditionId' value=" + number + "/>";
            $("#ConditionForm").append(q);

            for (let i in condition) {
                //let StorySeries = "<input hidden type='text' name='storyStates[" + i + "].StorySeries' id='storyStates[" + i + "].StorySeries'/>";
                let Name = "<input  type='text' name='storyStates[" + i + "].Name' id='storyStates[" + i + "].Name'/>";
                let Type = "<select  name='storyStates[" + i + "].Type' id='storyStates[" + i + "].Type'>" 
                    + "<option value='1'>></option>"
                    + "<option value='2'><</option>"
                    + "<option value='3'>=</option>"
                    + "<option value='4'>≠</option>"
                    + "</select>";
                let Value = "<input  type='text' name='storyStates[" + i + "].Value' id='storyStates[" + i + "].Value'/>";
                let Delete = "<button onclick='ConditionCancel(" + i + ")'>取消</button>";
                let context = StorySeries + Name + Type + Value + Delete;
                let toappend = "<div class='row' id='condition" + i + "'>" + context + "</div>"
                $("#ConditionForm").append(toappend)
                conditioncount++;
                //赋值
                //$("#storyStates[" + i + "].StorySeries").val(condition[i].StorySeries);
                $("#storyStates[" + i + "].Name").val(condition[i].Name);
                $("#storyStates[" + i + "].Type").text(enumConditionType[json[i].Type]);
                $("#storyStates[" + i + "].Type").val(condition[i].Type);
                $("#storyStates[" + i + "].Value").val(condition[i].Value);

            }
        }

        $('#ConditionModel').modal('show');

    }

    //取消条件
    function ConditionCancel(conditionID) {
        $("#condition" + conditionID + "").remove();
        conditioncount--;
    }

    function SaveCondition() {
        let i = $("#ConditionId").val();
        let value = $("#ConditionForm").serialize();
        $("#storyCard.StoryOptions[" + i + "].Condition").val(value); 
        $("#ConditionModel").modal('hide')
    }

    //增加条件
    function AddCondition() {
        let i = conditioncount;
        let Name = "<input  type='text' name='storyStates[" + i + "].Name' id='storyStates[" + i + "].Name'/>";
        let Type = "<select  name='storyStates[" + i + "].Type' id='storyStates[" + i + "].Type'>" 
            + "<option value='1'>></option>"
            + "<option value='2'><</option>"
            + "<option value='3'>=</option>"
            + "<option value='4'>≠</option>"
            + "</select>";
        let Value = "<input  type='text' name='storyStates[" + i + "].Value' id='storyStates[" + i + "].Value'/>";
        let Delete = "<button onclick='ConditionCancel(" + i + ")'>取消</button>";
        let context =  Name + Type + Value + Delete;
        let toappend = "<div class='row' id='condition" + i + "'>" + context + "</div>"
        $("#ConditionForm").append(toappend)
    }

    //设置效果
    var effectcount = 0; //当前页面有多少个条件
    function Effect(number) {
        var EffectForm = document.getElementById("EffectForm");
        EffectForm.innerHTML = "";
        effectcount = 0;
        let effect = JSON.parse($("#storyCard.StoryOptions[" + number + "].Effect").val());
        if (effect) {
            let q = "<input hidden type='text' id='EffectId' value=" + number + "/>";
            $("#EffectForm").append(q);
        }
    }

    //生成uuid
    function S4() {
        return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
    }
    function guid() {
        return (S4() + S4() + "-" + S4() + "-" + S4() + "-" + S4() + "-" + S4() + S4() + S4());
    }


</script>

